// fib.yapl - Print Fibonacci numbers up to the largest that fits in uint16
// Compile together with bootstrap.yapl and itoa.yapl

// Largest Fibonacci number that fits in uint16 (65535)
const uint16 MAX_FIB = 46368;

func void main() {
    var byte buf[6];
    var uint16 n1;
    var uint16 n2;
    var uint16 next;

    n1 = 0;
    n2 = 1;

    // Print first Fibonacci number (1)
    Utoa(n2, &buf[0]);
    Putstr(&buf[0]);
    Putc(byte('\n'));

    // Generate and print remaining Fibonacci numbers
    while (n1 + n2 <= MAX_FIB) {
        next = n1 + n2;
        Utoa(next, &buf[0]);
        Putstr(&buf[0]);
        Putc(byte('\n'));
        n1 = n2;
        n2 = next;
    }
}

// Write a byte to the serial transmit FIFO
func void Putc(byte b) {
    #asm("ldi r2 96");
    #asm("ssp r1 r2");
}

// Return 1 if the transmit FIFO overflowed, 0 otherwise
func byte isOverflow() {
    #asm("ldi r2 98");
    #asm("lsp r1 r2");
    #asm("ldi r2 1");
    #asm("and r1 r1 r2");
}

// Print a null-terminated string
func void Putstr(@byte bp) {
    while (@bp != 0) {
        Putc(@bp);
        if (isOverflow()) {
            continue;
        }
        bp = bp + 1;
    }
}
