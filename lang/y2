#!/bin/bash
# YAPL compiler driver
# Usage: ./y <source.yapl>
#        ./y -              (read from stdin)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
set -o pipefail

if [ $# -eq 0 ]; then
    echo "Usage: $0 <source.yapl>" >&2
    echo "       $0 -  (read from stdin)" >&2
    exit 1
fi

SOURCE="$1"

if [ "$SOURCE" = "-" ]; then
    # Read from stdin
    cat | "$SCRIPT_DIR/ylex/ylex" - | "$SCRIPT_DIR/parse/parse" | "$SCRIPT_DIR/sem/sem"
else
    if ! [ -r "$SOURCE" ]; then
        echo "Error: $SOURCE not found" >&2
        exit 1
    fi
    ASMSRC="$(basename -s yapl "$SOURCE")asm"
    echo ASMSRC in "$ASMSRC"

    cat "$SOURCE" | "$SCRIPT_DIR/ylex/ylex" "$SOURCE" | "$SCRIPT_DIR/parse/parse" | "$SCRIPT_DIR/sem/sem" | $SCRIPT_DIR/gen/gen > "$ASMSRC" 
    asm "$ASMSRC" -o wut4.out
fi
