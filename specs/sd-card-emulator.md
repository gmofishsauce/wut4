# Emulated SD card

The emulator implements an SPI connected mass storage device (SD card). Device registers wider than 8 bits are accessed byte at a time as they would be through an SPI interface, with the most significant byte of commands sent first and the byte containing the least significant bits of the wide command sent last (and similarly for device responses). The SPI serial data path itself is not emulated except as required to implement this byte-at-a-time access. A FIFO or Golang channel may be used for this purpose. 

The emulated SPI interface has two registers called s0 and s1 at WUT-4 special register addresses 100 and 101 (decimal). Within the interface, s0 (100) is the data read/write register and S1 is the select register..  Bits are assigned in the select register to select specific emulated devices. Within the select register, bit 0 drives the select line of the emulated SD card. The other bits of the select register are reserved for future emulated SPI devices. All select lines are active when low (0) and inactive when high(1).The operating system should write 0xFF to the select register early in the boot sequence to deselect all SPI devices until they can be properly initialized. 

To simplify the emulator, no SDIO features are implemented within the emulated SD card; that is, the emulated card is a pure version 2 SD memory; even high-capacity (SDHC/SDXC) SD cards are not supported. SD cards sometimes report errors by returning nothing at all  (“timing out”). This is usually detected by reading 0xFF at the device read register. The emulator should reproduce this behavior, returning 0XFF for reads from the device read register s0 if the emulated device has not produced any response to the previous command.

In the emulator, SD cards are represented by files in the host file system. They are made known to the emulator with the -sd  command line option to the emulator which must be followed by a file name. The file can be located anywhere in the host file system, but it must have read write permission to the user. Only one such file, representing exactly one SD card, can be made known to the emulator on any given execution. The SD card file must be specified on the emulator command line. There is no way to change it or to connect an SD device while the emulator is running. Files used as SD cards must be at least one sector (512 bytes) in length,must be a multiple of 512 bytes in length, and must not exceed 2 GB in length because that is the standard SD card size limit. Files representing SD cards need not have any specific content. They may be created, for example, with the dd command or they may contain a FAT file system, which emulated software may (or may not) be capable of interpreting.

Claude code: In your prompt you should have received the pathnames of local file copies of an SD interface tutorial, which is also in the repo at the pseudo-URLs <github>:gmofishsauce/wut4/specs{sd-card{1,2,3,4}.mhtml. The tutorial describes the complex initialization sequence for an SD card. The emulator should require that the initialization sequence described in this tutorial be followed closely, beginning with at least 10 bytes of 0XFF with the card deselected. If the emulator does not observe these The expected initialization sequence including CMD0 CMD8 CMD58 and the CMD55 ACMD41 combination described in the tutorial it should enter an unrecoverable error state and respond by timing out all following commands. Presumably the emulator will require some type of state machine to ensure that these initialization commands are issued in the proper order. Also note that each of these commands has a specific response format that the host software performing the initialization will expect. The emulator must generate all these specific response formats.

It is important to note that because the emulator is emulating a standard SD card,the cmd17/cmd24 read/write commands must use byte addressing for the data to be read or written. The emulator may assume that every such bite address will be a multiple of 512, that is, on a sector boundary. In summary the emulator must support only the initialization commands (CMD0 CMD8 CMD58 and the CMD55 ACMD41 combination) CMD17, and CMD24, with those last two commands supporting only byte addressing on 512 byte boundaries within the host file representing the emulated SD device. 

